---
- name: clean up the old dir
  ansible.windows.win_file:
    path: C:\testdir\
    state: absent

- name: create testdir\src directory for CI
  ansible.windows.win_file:
    path: C:\testdir\src\
    state: directory

- name: create testdir\zipped directory for CI
  ansible.windows.win_file:
    path: C:\testdir\zipped\
    state: directory

- name: create test files for CI
  ansible.builtin.win_shell: 'Set-Content -LiteralPath C:\testdir\src\test.txt -Value "This is a test file."' 

# Case01: Check file compression
- name: compress a file (check)
  win_zip:
    src: C:\testdir\src\test.txt
    dest: C:\testdir\zipped\test_file.zip
  register: zip_check
  check_mode: yes

- name: get result of compress zip (check)
  ansible.windows.win_stat:
    path: C:\testdir\zipped\test_file.zip
  register: zip_actual_check

- name: assert result of zip (check)
  assert:
    that:
    - zip_check is changed
    - not zip_actual_check.stat.exists

- name: compress a file
  win_zip:
    src: C:\testdir\src\test.txt
    dest: C:\testdir\zipped\test_file.zip
  register: zip

- name: get result of compress zip
  ansible.windows.win_stat:
    path: C:\testdir\zipped\test_file.zip
  register: zip_actual

- name: assert result of zip
  assert:
    that:
    - zip is changed
    - zip_actual.stat.exists

# Case02: Check directory compression
- name: compress a directory (check)
  win_zip:
    src: C:\testdir\src\
    dest: C:\testdir\test_dir.zip
  register: zip_check
  check_mode: yes

- name: get result of compress zip (check)
  ansible.windows.win_stat:
    path: C:\testdir\test_dir.zip
  register: zip_actual_check

- name: assert result of zip (check)
  assert:
    that:
    - zip_check is changed
    - not zip_actual_check.stat.exists

- name: compress a directory
  win_zip:
    src: C:\testdir\src\
    dest: C:\testdir\test_dir.zip
  register: zip

- name: get result of compress zip
  ansible.windows.win_stat:
    path: C:\testdir\test_dir.zip
  register: zip_actual

- name: assert result of zip
  assert:
    that:
    - zip is changed
    - zip_actual.stat.exists

- name: compress a file with existing dest (check)
  win_zip:
    src: C:\testdir\src\test.txt
    dest: C:\testdir\zipped\test_file.zip
  register: zip_check
  check_mode: yes

- name: assert result of zip (check)
  assert:
    that:
    - zip_check is skipped

- name: compress a file to existing dest 
  win_zip:
    src: C:\testdir\src\test.txt
    dest: C:\testdir\zipped\test_file.zip
  register: zip

- name: assert result of zip
  assert:
    that:
    - zip is skipped
