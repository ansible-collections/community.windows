---
- name: Setup structure for checkmode
  block:
    - name: Ensure OU structure is present
      community.windows.win_domain_ou:
        name: "{{ item.name }}"
        protected: false
        path: "{{ item.path }}"
      loop: "{{ win_domain_ou_structure }}"
      register: test4
      failed_when: test4 is not changed

- name: Run Check Mode Tests
  block:
    - name: Ensure OU is present (check_mode)
      community.windows.win_domain_ou:
        name: ansible_checkmode
      register: test1c
      failed_when: test1c is not changed

    - name: Ensure OU has updated properties (check_mode)
      community.windows.win_domain_ou:
        name: End User Computing
        protected: true
        path: "{{ win_domain_ou_root_path }}"
        properties:
          city: Sandy Springs
          state: Georgia
          streetaddress: 1155 Perimeter Center West
          country: US
          description: EUC Business Unit
          postalcode: 30189
      register: test2c
      failed_when: test2c is not changed

    - name: Ensure OU structure win_domain_ou_structure_check_mode is present (check_mode)
      community.windows.win_domain_ou:
        name: "{{ item.name }}"
        protected: false
        path: "{{ item.path }}"
      loop: "{{ win_domain_ou_structure_check_mode }}"
      register: test3c
      failed_when: test3c is not changed

    - name: Ensure OU structure win_domain_ou_structure is present (check_mode)
      community.windows.win_domain_ou:
        name: "{{ item.name }}"
        protected: false
        path: "{{ item.path }}"
      loop: "{{ win_domain_ou_structure }}"
      register: test3d
      failed_when: test3d is changed

    - name: Ensure OU structure is absent, recursive (check_mode)
      community.windows.win_domain_ou:
        name: VMware
        path: "{{ win_domain_ou_root_path }}"
        state: absent
        recursive: true
      register: test4c
      failed_when: test4c is not changed

    - name: Ensure OU is present with specific properties (check_mode)
      community.windows.win_domain_ou:
        name: VMW Atlanta
        path: "{{ win_domain_ou_root_path }}"
        properties:
          city: Sandy Springs
          state: Georgia
          streetaddress: 1155 Perimeter Center West
      register: test5c
      failed_when: test5c is not changed

    - name: Ensure OU is present with specific properties added (check_mode)
      community.windows.win_domain_ou:
        name: VMW Atlanta
        path: "{{ win_domain_ou_root_path }}"
        properties:
          country: US
          description: EUC Business Unit
          postalcode: 30189
      register: test6c
      failed_when: test6c is not changed

    - name: Ensure existing ou 'End User Computing' is absent (check_mode)
      community.windows.win_domain_ou:
        name: End User Computing
        path: "OU=VMware,{{ win_domain_ou_root_path }}"
        state: absent
      register: test7c
      failed_when: test7c is not changed

    - name: Ensure NonExisting OU 'VMW Atlanta' is absent (check_mode)
      community.windows.win_domain_ou:
        name: "VMW Atlanta"
        path: "{{ win_domain_ou_root_path }}"
        state: absent
      register: test8c
      failed_when: test8c is changed
  check_mode: true

- name: sanity check on check_mode
  ansible.windows.win_shell: |
    get-adorganizationalunit -Identity ansible_checkmode
  register: test1d
  failed_when: "'ansible_checkmode' in test1d.stdout"
  changed_when: false

- name: Teardown structure used for checkmode
  community.windows.win_domain_ou:
    name: VMware
    path: "{{ win_domain_ou_root_path }}"
    state: absent
    recursive: true
  register: test6
  failed_when: test6 is not changed
