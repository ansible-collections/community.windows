- name: get PowerShell version
  ansible.windows.win_shell: $PSVersionTable.PSVersion.Major
  register: ps_version

- name: skip if running PowerShell 7
  when: ps_version.stdout|int >= 7
  block:
  - name: ensure IIS features are installed
    ansible.windows.win_feature:
      name: Web-Server
      state: present
      include_management_tools: True
    register: feature_install

  - name: reboot after feature install
    ansible.windows.win_reboot:
    when: feature_install.reboot_required

  - name: set version of IIS for tests
    win_file_version:
      path: C:\Windows\System32\inetsrv\w3wp.exe
    register: iis_version

  - name: ensure test pool is deleted as a baseline
    win_iis_webapppool:
      name: '{{test_iis_webapppool_name}}'
      state: absent

  # Tests
  - name: run tests on hosts that support it
    include_tasks: tests.yml

  always:
  - name: ensure test pool is deleted
    win_iis_webapppool:
      name: '{{test_iis_webapppool_name}}'
      state: absent
