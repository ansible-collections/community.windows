---
- name: Add a static route.
  win_route:
    network: "{{ destination_network }}"
    mask: "{{ destination_mask }}"
    gateway: "{{ default_gateway }}"
    metric: 1
    state: present
  register: route

- name: Check if route successfully added.
  ansible.windows.win_shell: (Get-CimInstance Win32_IP4PersistedRouteTable -Filter "Destination = '{{ destination_network }}'").Caption
  register: route_added

- name: Check route default gateway.
  ansible.windows.win_shell: (Get-CimInstance Win32_IP4PersistedRouteTable -Filter "Destination = '{{ destination_network }}'").NextHop
  register: route_gateway

- name: Test if route was successfully added.
  assert:
    that:
      - route is changed
      - route_added.stdout_lines[0] == "{{ destination_network }}"
      - route_gateway.stdout_lines[0] == "{{ default_gateway }}"

- name: Add a static route to test idempotency.
  win_route:
    network: "{{ destination_network }}"
    mask: "{{ destination_mask }}"
    gateway: "{{ default_gateway }}"
    metric: 1
    state: present
  register: idempotent_route

- name: Test idempotency.
  assert:
    that:
      - idempotent_route is not changed
      - idempotent_route.output == "Static route already exists."

- name: Remove static route.
  win_route:
    network: "{{ destination_network }}"
    mask: "{{ destination_mask }}"
    gateway: "{{ default_gateway }}"
    state: absent
  register: route_removed

- name: Check if static route was removed.
  ansible.windows.win_shell: Get-CimInstance Win32_IP4PersistedRouteTable -Filter "Destination = '{{ destination_network }}'"
  register: check_route_removed

- name: Test if static route was removed.
  assert:
    that:
      - route_removed is changed
      - check_route_removed.stdout == ''

- name: Remove static route to test idempotency.
  win_route:
    network: "{{ destination_network }}"
    mask: "{{ destination_mask }}"
    gateway: "{{ default_gateway }}"
    state: absent
  register: idempotent_route_removed

- name: Test idempotency.
  assert:
    that:
      - idempotent_route_removed is not changed
      - idempotent_route_removed.output == "No route to remove."

- name: Add static route to wrong IP address.
  win_route:
    network: 715.18.0.0
    mask: "{{ destination_mask }}"
    gateway: "{{ default_gateway }}"
    metric: 1
    state: present
  ignore_errors: yes
  register: wrong_ip

- name: Test static route addition to wrong IP address.
  assert:
    that:
      - wrong_ip is failed
